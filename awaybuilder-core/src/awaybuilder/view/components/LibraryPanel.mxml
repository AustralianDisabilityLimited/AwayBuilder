<?xml version="1.0" encoding="utf-8"?>
<controls:CollapsiblePanel xmlns:fx="http://ns.adobe.com/mxml/2009" 
						   xmlns:s="library://ns.adobe.com/flex/spark" 
						   xmlns:mx="library://ns.adobe.com/flex/mx" 
						   xmlns:controls="awaybuilder.view.components.controls.*" 
						   xmlns:tree="awaybuilder.view.components.controls.tree.*"
						   skinClass="awaybuilder.view.skins.CollapsiblePanelSkin" creationComplete="collapsiblepanel_creationCompleteHandler(event)">
	<fx:Declarations>
		<s:Power id="collapseEaser" exponent="2" easeInFraction="0.1" />
		<s:Resize id="collapseEffect" duration="150" easer="{collapseEaser}" heightTo="24" />
		<fx:Component className="NewAnimatorPopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();">
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New SkeletonAnimator" styleName="addItemButton" cornerRadius="0" click="close(true,'SkeletonAnimator')"/>
				<s:Button width="100%" label="New VertexAnimator" styleName="addItemButton" cornerRadius="0" click="close(true,'VertexAnimator')"/>
				<s:Button width="100%" label="New SkeletonAnimationSet" styleName="addItemButton" cornerRadius="0" click="close(true,'SkeletonAnimationSet')"/>
				<s:Button width="100%" label="New VertexAnimationSet" styleName="addItemButton" cornerRadius="0" click="close(true,'VertexAnimationSet')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
		<fx:Component className="NewTexturePopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();">
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New Texture" styleName="addItemButton" cornerRadius="0" click="close(true,'newTexture')"/>
				<s:Button width="100%" label="New Cube Texture" styleName="addItemButton" cornerRadius="0" click="close(true,'newCubeTexture')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
		<fx:Component className="NewLightPopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();">
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New Directional Light" styleName="addItemButton" cornerRadius="0" click="close(true,'newDirectionalLight')"/>
				<s:Button width="100%" label="New Point Light" styleName="addItemButton" cornerRadius="0" click="close(true,'newPointLight')"/>
				<s:Button width="100%" label="New Light Picker" styleName="addItemButton" cornerRadius="0" click="close(true,'newLightPicker')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
		<fx:Component className="NewEffectPopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();">
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New LightMapMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'LightMapMethod')"/>
				<s:Button width="100%" label="New ProjectiveTextureMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'ProjectiveTextureMethod')"/>
				<s:Button width="100%" label="New RimLightMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'RimLightMethod')"/>
				<s:Button width="100%" label="New ColorTransformMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'ColorTransformMethod')"/>
				<s:Button width="100%" label="New AlphaMaskMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'AlphaMaskMethod')"/>
				<s:Button width="100%" label="New ColorMatrixMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'ColorMatrixMethod')"/>
				<s:Button width="100%" label="New RefractionEnvMapMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'RefractionEnvMapMethod')"/>
				<s:Button width="100%" label="New OutlineMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'OutlineMethod')"/>
				<s:Button width="100%" label="New FresnelEnvMapMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'FresnelEnvMapMethod')"/>
				<s:Button width="100%" label="New FogMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'FogMethod')"/>
				<s:Button width="100%" label="New EnvMapMethod" styleName="addItemButton" cornerRadius="0" click="close(true,'EnvMapMethod')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
		<fx:Component className="NewGeometryPopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();" >
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New PlaneGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'PlaneGeometry')"/>
				<s:Button width="100%" label="New CubeGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'CubeGeometry')"/>
				<s:Button width="100%" label="New SphereGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'SphereGeometry')"/>
				<s:Button width="100%" label="New CylinderGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'CylinderGeometry')"/>
				<s:Button width="100%" label="New ConeGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'ConeGeometry')"/>
				<s:Button width="100%" label="New CapsuleGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'CapsuleGeometry')"/>
				<s:Button width="100%" label="New TorusGeometry" styleName="addItemButton" cornerRadius="0" click="close(true,'TorusGeometry')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
		<fx:Component className="NewObjectsPopup">
			<s:SkinnablePopUpContainer skinClass="awaybuilder.view.skins.LibrarySkinnablePopUpContainer" chromeColor="0x1d1d1c" color="0xdbdbdb" mouseDownOutside="close();" >
				<s:layout>
					<s:VerticalLayout gap="0"/>
				</s:layout>
				<s:Button width="100%" label="New ObjectContainer3D" styleName="addItemButton" cornerRadius="0" click="close(true,'ObjectContainer3D')"/>
				<s:Button width="100%" label="New Mesh" styleName="addItemButton" cornerRadius="0" click="close(true,'Mesh')"/>
				<s:Button width="100%" label="New SkyBox" styleName="addItemButton" cornerRadius="0" click="close(true,'SkyBox')"/>
				<s:Button width="100%" label="New Texture Projector" styleName="addItemButton" cornerRadius="0" click="close(true,'TextureProjector')"/>
			</s:SkinnablePopUpContainer>
		</fx:Component>
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import away3d.containers.ObjectContainer3D;
			
			import awaybuilder.model.vo.DocumentVO;
			import awaybuilder.model.vo.ScenegraphItemVO;
			import awaybuilder.view.components.controls.tree.TreeEvent;
			import awaybuilder.view.components.events.CoreEditorEvent;
			import awaybuilder.view.components.events.LibraryPanelEvent;
			
			import flash.utils.clearTimeout;
			import flash.utils.setTimeout;
			
			import mx.collections.ArrayCollection;
			import mx.events.DragEvent;
			import mx.events.FlexEvent;
			import mx.events.SandboxMouseEvent;
			
			import spark.components.supportClasses.ButtonBase;
			import spark.events.IndexChangeEvent;
			import spark.events.PopUpEvent;
			
			[Bindable] 
			public var model:DocumentVO;
			
			[Bindable] 
			public var selectedSceneItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedMaterialsItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedTexturesItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedGeometryItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedMethodsItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedAnimationsItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedSkeletonsItems:Vector.<Object> = new Vector.<Object>();
			[Bindable] 
			public var selectedLightsItems:Vector.<Object> = new Vector.<Object>();
			
			private var _expandedPanel:CollapsiblePanel;
			private var _panels:Array;
			
			private var _tempSelectedItems:Vector.<Object>;
			
			protected function panel_collapsedChangeHandler(event:Event):void
			{
				var panel:CollapsiblePanel = event.target as CollapsiblePanel;
				if( panel.collapsed ) 
				{
					collapseEffect.play( [panel] );
					
					if( _expandedPanel == panel ) 
					{
						getNextPanel(panel).collapsed = false;
					}
				}
				else 
				{
					_expandedPanel = panel;
					panel.percentHeight = 100;
					collapseAllExcept( panel );
				}
			}
			private function collapseAllExcept( panel:CollapsiblePanel ):void
			{
				for each( var p:CollapsiblePanel in _panels )
				{
					if( p != panel ) p.collapsed = true;
				}
			}
			private function getNextPanel( panel:CollapsiblePanel ):CollapsiblePanel
			{
				var result:int = 0;
				for (var i:int = 0; i < _panels.length; i++) 
				{
					if( _panels[i] == panel ) 
					{
						if( i+1 < _panels.length ) return _panels[i+1]
					}
						
				}
				return _panels[0];
			}
			
			protected function collapsiblepanel_creationCompleteHandler(event:FlexEvent):void
			{
				_expandedPanel = scenePanel;
				_panels = [scenePanel,materialsPanel,texturesPanel,geometryPanel,methodsPanel,animationsPanel,lightsPanel ];
			}
			
			protected function tree_changeHandler(event:IndexChangeEvent):void
			{
				var tree:Tree = event.target as Tree;
				_tempSelectedItems = tree.selectedItems;
				
				systemManager.getSandboxRoot().addEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, mouseUpHandler, false, 0, true);
				systemManager.getSandboxRoot().addEventListener(MouseEvent.MOUSE_UP, mouseUpHandler, false, 0, true);
			}
			
			private function mouseUpHandler( event:Event ):void
			{
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.TREE_CHANGE, _tempSelectedItems ) );
				systemManager.getSandboxRoot().removeEventListener(MouseEvent.MOUSE_UP, mouseUpHandler, false);
				systemManager.getSandboxRoot().removeEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, mouseUpHandler, false);
			}
			
			protected function texturesPanel_addNewItemHandler(event:MouseEvent):void
			{
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewTexturePopup = new NewTexturePopup();
				popup.open(this);
				popup.addEventListener('close', newTexturePopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
			}
			protected function materialsPanel_addNewItemHandler(event:MouseEvent):void
			{
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_MATERIAL ) );
			}
			protected function scenePanel_addNewItemHandler(event:MouseEvent):void
			{
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewObjectsPopup = new NewObjectsPopup();
				popup.open(this);
				popup.addEventListener('close', newObjectPopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
			}
			
			private function newObjectPopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				switch(event.data)
				{
					case "ObjectContainer3D":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_CONTAINER ) );
						break;
					case "Mesh":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_MESH ) );
						break;
					case "TextureProjector":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_TEXTURE_PROJECTOR ) );
						break;
					default:
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_SKYBOX ) );
						break;
				}
			}  
			private function newTexturePopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				switch(event.data)
				{
					case "newTexture":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_TEXTURE ) );
						break;
					default:
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_CUBE_TEXTURE ) );
						break;
				}
			}   
			private function lightsPanel_addNewItemHandler(event:MouseEvent):void
			{
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewLightPopup = new NewLightPopup();
				popup.open(this);
				popup.addEventListener('close', newLightPopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
			}
			private function methodsPanel_addNewItemHandler(event:MouseEvent):void
			{
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewEffectPopup = new NewEffectPopup();
				popup.open(this);
				popup.addEventListener('close', newEffectPopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
			}
			private function geometryPanel_addNewItemHandler(event:MouseEvent):void
			{
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewGeometryPopup = new NewGeometryPopup();
				popup.open(this);
				popup.addEventListener('close', newGeometryPopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
			}
			
			private function newEffectPopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_EFFECTMETHOD, event.data ) );
			}  
			private function newGeometryPopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_GEOMETRY, event.data ) );
			}  
			
			private function newLightPopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				switch(event.data)
				{
					
					case "newLightPicker":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_LIGHTPICKER ) );
						break;
					case "newDirectionalLight":
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_DIRECTIONAL_LIGHT ) );
						break;
					default:
						this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_POINT_LIGHT ) );
						break;
				}
			}   
			
			protected function tree_dragStartHandler(event:DragEvent):void
			{
				systemManager.getSandboxRoot().removeEventListener(MouseEvent.MOUSE_UP, mouseUpHandler, false);
				systemManager.getSandboxRoot().removeEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, mouseUpHandler, false);
			}
			
			protected function methodsTree_dragCompleteHandler(event:DragEvent):void
			{
				methodsTree.selectedItems = selectedMethodsItems;
			}
			
			protected function lightsTree_dragCompleteHandler(event:DragEvent):void
			{
				lightsTree.selectedItems = selectedLightsItems;
			}
			
			protected function lightsTree_itemDroppedHandler(event:TreeEvent):void
			{
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.LIGHT_DROPPED, event.item ) );
			}
			
			protected function animationsPanel_addNewItemHandler(event:MouseEvent):void
			{
				
				var button:ButtonBase = event.relatedObject as ButtonBase;
				var popup:NewAnimatorPopup = new NewAnimatorPopup();
				popup.open(this);
				popup.addEventListener('close', newNewAnimatorPopup_closeHandler);
				var pos:Point = button.localToGlobal( new Point() );
				popup.move( pos.x-4,  Math.min(pos.y-4, stage.height-popup.height-8) );
				
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_ANIMATOR ) );
			}
			private function newNewAnimatorPopup_closeHandler(event:PopUpEvent):void 
			{
				if (!event.commit) return;
				this.dispatchEvent( new LibraryPanelEvent( LibraryPanelEvent.ADD_ANIMATOR, event.data ) );
			}   
			
		]]>
	</fx:Script>
	<s:VGroup width="225" height="100%" gap="0">
		<controls:LibraryCollapsiblePanel id="scenePanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Scene Objects" width="100%" collapsed="false" height="100%" addEnabled="true"
								   addNewItem="scenePanel_addNewItemHandler(event)"
								   collapsedChange="panel_collapsedChangeHandler(event)">
			<tree:Tree id="sceneTree" dataProvider="{model.scene}" selectedItems="{selectedSceneItems}" indentation="10"
					   dragEnabled="true" dropEnabled="true" dragMoveEnabled="true"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<controls:LibraryCollapsiblePanel  id="materialsPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
									title="Materials" height="24" width="100%" collapsed="true" addEnabled="true"
									collapsedChange="panel_collapsedChangeHandler(event)"
									addNewItem="materialsPanel_addNewItemHandler(event)">
			<tree:Tree id="materialTree" dataProvider="{model.materials}" selectedItems="{selectedMaterialsItems}" indentation="10"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<controls:LibraryCollapsiblePanel id="texturesPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Textures" height="24" width="100%" collapsed="true" addEnabled="true"
								   collapsedChange="panel_collapsedChangeHandler(event)"
								   addNewItem="texturesPanel_addNewItemHandler(event)">
			<tree:Tree id="texturesTree" dataProvider="{model.textures}" selectedItems="{selectedTexturesItems}" indentation="10"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<controls:LibraryCollapsiblePanel id="geometryPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Geometry" height="24" width="100%" collapsed="true" collapsedChange="panel_collapsedChangeHandler(event)"
								   addNewItem="geometryPanel_addNewItemHandler(event)" addEnabled="true">
			<tree:Tree id="geometryTree" dataProvider="{model.geometry}" selectedItems="{selectedGeometryItems}" indentation="10"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<controls:LibraryCollapsiblePanel id="methodsPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
										  title="Effects" height="24" width="100%" collapsed="true" addEnabled="true"
										  collapsedChange="panel_collapsedChangeHandler(event)"
										  addNewItem="methodsPanel_addNewItemHandler(event)">
			<tree:Tree id="methodsTree" dataProvider="{model.methods}" selectedItems="{selectedMethodsItems}" indentation="10"
					   dragMoveEnabled="false" dragEnabled="true" 
					   dragStart="tree_dragStartHandler(event)" dragComplete="methodsTree_dragCompleteHandler(event)"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<!--<controls:CollapsiblePanel id="skeletonsPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Skeletons" height="24" width="100%" collapsed="true" collapsedChange="panel_collapsedChangeHandler(event)">
			<tree:Tree id="skeletonsTree" dataProvider="{model.skeletons}" selectedItems="{selectedLightsItems}" indentation="10"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:CollapsiblePanel>-->
		<controls:LibraryCollapsiblePanel id="animationsPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Animations"  addEnabled="true"
								   height="24" width="100%" collapsed="true" 
								   collapsedChange="panel_collapsedChangeHandler(event)"
								   addNewItem="animationsPanel_addNewItemHandler(event)">
			<tree:Tree id="animationsTree" dataProvider="{model.animations}" selectedItems="{selectedAnimationsItems}" indentation="10"
					   change="tree_changeHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
		<controls:LibraryCollapsiblePanel id="lightsPanel" skinClass="awaybuilder.view.skins.CollapsibleDropdownLibraryPanelSkin" borderVisible="false"
								   title="Lights" height="24" width="100%" collapsed="true" addEnabled="true"
								   collapsedChange="panel_collapsedChangeHandler(event)"
								   addNewItem="lightsPanel_addNewItemHandler(event)">
			<tree:Tree id="lightsTree" dataProvider="{model.lights}" selectedItems="{selectedLightsItems}" indentation="10"
					   dragEnabled="true" dropEnabled="true" dragMoveEnabled="true"
					   dragStart="tree_dragStartHandler(event)"
					   itemDropped="lightsTree_itemDroppedHandler(event)"
					   change="tree_changeHandler(event)" dragComplete="lightsTree_dragCompleteHandler(event)"
					   width="100%" height="100%"/>
		</controls:LibraryCollapsiblePanel>
	</s:VGroup>
	
</controls:CollapsiblePanel>
